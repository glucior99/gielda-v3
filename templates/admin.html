<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>NECKS Portal Admin v5.3</title>
    <style>
        :root { --primary: #D32F2F; --nav: #1A237E; --bg: #f4f6f8; --card: #ffffff; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); padding: 20px; color: #333; font-size: 13px; margin: 0; }
        .nav-bar { background: white; padding: 15px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; margin-bottom: 20px; }
        .logo { font-size: 24px; font-weight: 900; color: var(--primary); }
        .nav-links a { margin-left: 20px; text-decoration: none; color: #555; font-weight: 600; font-size: 12px; }
        .nav-links a.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        .main-tabs { display: flex; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
        .main-tab { padding: 10px 20px; text-decoration: none; color: #555; font-weight: bold; }
        .main-tab.active { color: var(--primary); border-bottom: 4px solid var(--primary); }
        .grid { display: grid; grid-template-columns: 250px 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-group { margin-bottom: 10px; }
        .form-label { display: block; font-weight: bold; font-size: 11px; color: #777; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .btn { padding: 8px 15px; background: var(--nav); color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; text-decoration: none; display: inline-block; font-size: 12px; }
        .btn-danger { background: var(--primary); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        th { text-align: left; padding: 10px; background: #eee; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .list-group a { display: block; padding: 10px; border-bottom: 1px solid #eee; text-decoration: none; color: #333; }
        .list-group a.active { background: #e8eaf6; border-left: 4px solid var(--nav); }
        .settings-container { display: flex; gap: 20px; }
        .settings-menu { width: 200px; border-right: 1px solid #eee; }
        .set-link { display: block; padding: 10px; cursor: pointer; font-weight: bold; color: #555; }
        .set-link.active { color: var(--nav); background: #f5f5f5; border-left: 3px solid var(--nav); }
        .settings-content { flex: 1; }
        .status-tab { display: inline-block; padding: 5px 15px; border: 1px solid #ccc; cursor: pointer; border-radius: 20px; font-weight: bold; font-size: 11px; margin-right: 5px; color: #555; text-decoration: none; }
        .status-tab.active { background: var(--nav); color: white; border-color: var(--nav); }
        .flash { background: #ffcdd2; color: #b71c1c; padding: 10px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #ef9a9a; }
    </style>
    <script>
        function showSetting(id) {
            document.querySelectorAll('.set-content').forEach(d => d.style.display = 'none');
            document.querySelectorAll('.set-link').forEach(t => t.classList.remove('active'));
            document.getElementById(id).style.display = 'block';
            document.getElementById('link-'+id).classList.add('active');
        }
        function toggleSpedycjaFields() {
            var cat = document.getElementById('catSelect').value;
            var isSpedycja = (cat === 'Spedycja');
            document.getElementById('spedycjaLogistics').style.display = isSpedycja ? 'flex' : 'none';
            document.getElementById('spedycjaFiles').style.display = isSpedycja ? 'block' : 'none';
        }
    </script>
</head>
<body>

<div class="nav-bar">
    <div class="logo">NECKS <span>ADMIN</span></div>
    <div class="nav-links">
        <a href="/admin?view=dashboard" class="{{ 'active' if view == 'dashboard' }}">DASHBOARD</a>
        <a href="/admin?view=users" class="{{ 'active' if view == 'users' }}">U≈ªYTKOWNICY</a>
        <a href="/admin?view=open" class="{{ 'active' if view == 'open' }}">OTWARTE</a>
        <a href="/admin?view=closed" class="{{ 'active' if view == 'closed' }}">ZAMKNIƒòTE</a>
        <a href="/admin?view=archive" class="{{ 'active' if view == 'archive' }}">ARCHIWUM</a>
        <a href="/admin?view=settings" class="{{ 'active' if view == 'settings' }}">USTAWIENIA</a>
        <a href="/logout">WYLOGUJ</a>
    </div>
</div>

{% with messages = get_flashed_messages() %}
    {% if messages %}<div class="flash">{{ messages[0] }}</div>{% endif %}
{% endwith %}

{% if view == 'settings' %}
<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div class="settings-container">
        <div class="settings-menu">
            <div id="link-mail" class="set-link active" onclick="showSetting('mail')">üìß Tre≈õƒá Maila</div>
            <div id="link-cbam" class="set-link" onclick="showSetting('cbam')">üåç CBAM</div>
        </div>
        <div class="settings-content">
            <div id="mail" class="set-content">
                <h3>Szablon Powiadomienia</h3>
                <form action="/settings" method="post">
                    <label class="form-label">Zmienne: {GIE≈ÅDA}, {DATA}, {WARUNKI_LOGISTYCZNE}</label>
                    <textarea name="mail_template" rows="12">{{ email_template }}</textarea>
                    <button class="btn" style="margin-top:10px;">Zapisz Szablon</button>
                </form>
            </div>
            <div id="cbam" class="set-content" style="display:none;"><h3>CBAM</h3><p>Modu≈Ç w budowie.</p></div>
        </div>
    </div>
</div>
{% endif %}

{% if view == 'dashboard' %}
<div class="card" style="max-width: 800px; margin: 0 auto;">
    <h3>Nowa Gie≈Çda</h3>
    <form method="post" enctype="multipart/form-data">
        <input type="hidden" name="form_type" value="create_exchange">
        <div class="form-group"><label class="form-label">Nazwa</label><input type="text" name="exchange_name" required></div>
        <div style="display:flex; gap:15px;">
            <div class="form-group" style="flex:1"><label class="form-label">Kategoria</label>
                <select name="category" id="catSelect" onchange="toggleSpedycjaFields()">
                    <option value="Spedycja">Spedycja</option>
                    <option value="Material">Materia≈Ç</option>
                    <option value="Wycena">Wycena</option>
                </select>
            </div>
            <div class="form-group" style="flex:1"><label class="form-label">Deadline</label><input type="datetime-local" name="deadline" required></div>
        </div>

        <div id="spedycjaLogistics" style="display:flex; gap:15px; background:#f9f9f9; padding:10px; margin-bottom:10px;">
            <div class="form-group" style="flex:1">
                <label class="form-label">Incoterms</label>
                <select name="incoterms">
                    <option value="EXW">EXW</option><option value="FOB">FOB</option><option value="FCA">FCA</option>
                    <option value="DAP">DAP</option><option value="DDP">DDP</option>
                </select>
            </div>
            <div class="form-group" style="flex:1"><label class="form-label">Port Za≈Çadunku</label><input type="text" name="port_loading"></div>
            <div class="form-group" style="flex:1"><label class="form-label">Termin Odbioru</label><input type="text" name="pickup_date"></div>
        </div>

        <div class="form-group"><label class="form-label">Opis</label><textarea name="desc" rows="3"></textarea></div>

        <div id="spedycjaFiles" style="background:#e3f2fd; padding:10px; margin-bottom:10px;">
            <div class="form-group"><label class="form-label">Packing List (PDF)</label><input type="file" name="af1"></div>
            <div class="form-group"><label class="form-label">Inne (PDF)</label><input type="file" name="af2"></div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <div class="form-group"><label class="form-label">EUR</label><input type="text" name="eur_rate" value="{{ live_eur }}"></div>
            <div class="form-group"><label class="form-label">USD</label><input type="text" name="usd_rate" value="{{ live_usd }}"></div>
        </div>
        <div class="form-group"><label><input type="checkbox" name="notify_enabled"> Auto-Alert</label></div>
        <button class="btn">Utw√≥rz</button>
    </form>
    <script>toggleSpedycjaFields();</script>
</div>
{% endif %}

{% if view == 'users' %}
<div class="card">
    <div style="margin-bottom:15px;">
        <a href="/admin?view=users&user_cat=Spedycja" class="btn" style="background:{{ 'var(--nav)' if user_cat_tab=='Spedycja' else '#ccc' }}">Spedycja</a>
        <a href="/admin?view=users&user_cat=Material" class="btn" style="background:{{ 'var(--nav)' if user_cat_tab=='Material' else '#ccc' }}">Materia≈Ç</a>
        <a href="/admin?view=users&user_cat=Wycena" class="btn" style="background:{{ 'var(--nav)' if user_cat_tab=='Wycena' else '#ccc' }}">Wycena</a>
    </div>
    
    <div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
        <a href="/admin?view=users&user_cat={{ user_cat_tab }}&status_tab=active" class="status-tab {{ 'active' if status_tab == 'active' }}">üü¢ AKTYWNI</a>
        <a href="/admin?view=users&user_cat={{ user_cat_tab }}&status_tab=inactive" class="status-tab {{ 'active' if status_tab == 'inactive' }}">üî¥ NIEAKTYWNI</a>
    </div>
    
    {% if status_tab == 'active' %}
    <form action="/manage_user" method="post" style="background:#e8f5e9; padding:10px; margin-bottom:15px;">
        <input type="hidden" name="action" value="add">
        <input type="hidden" name="category" value="{{ user_cat_tab }}">
        <input type="hidden" name="category_filter" value="{{ user_cat_tab }}">
        <input type="hidden" name="status_tab" value="{{ status_tab }}">
        <input type="text" name="username" placeholder="Email/Login" required style="width:200px;">
        <input type="text" name="password" placeholder="Has≈Ço" required style="width:200px;">
        <button class="btn">Dodaj Usera</button>
    </form>
    {% endif %}

    <table>
        <tr><th>User</th><th>Has≈Ço</th><th>Akcja</th></tr>
        {% set show_active = 1 if status_tab == 'active' else 0 %}
        {% for u in all_users_list if u[3] == user_cat_tab and u[2] == show_active %}
        <tr>
            <form action="/manage_user" method="post">
                <input type="hidden" name="uid" value="{{ u[0] }}">
                <input type="hidden" name="category_filter" value="{{ user_cat_tab }}">
                <input type="hidden" name="status_tab" value="{{ status_tab }}">
                <td><input type="text" name="username" value="{{ u[1] }}"></td>
                <td><input type="text" name="password" placeholder="Zmie≈Ñ has≈Ço"></td>
                <td>
                    <button name="action" value="edit" class="btn btn-sm">Zapisz</button>
                    <button name="action" value="toggle" class="btn btn-sm" style="background:{{ '#7f8c8d' if u[2] else '#2e7d32' }};">{{ 'Wy≈ÇƒÖcz' if u[2] else 'W≈ÇƒÖcz' }}</button>
                    <button name="action" value="delete" class="btn btn-sm btn-danger">X</button>
                </td>
            </form>
        </tr>
        {% endfor %}
    </table>
</div>
{% endif %}

{% if view in ['open', 'closed', 'archive'] %}
<div class="grid">
    <div class="card" style="padding:0;">
        {% if view == 'archive' %}
            {% for f in archive_folders.keys() %}
                <a href="/admin?view=archive&folder={{ f }}" style="display:block; padding:10px; border-bottom:1px solid #eee;">üìÇ {{ f }}</a>
            {% endfor %}
        {% endif %}
        
        <div style="display:flex; border-bottom:1px solid #ddd;">
            <a href="/admin?view={{ view }}&ex_cat=Spedycja" style="flex:1; text-align:center; padding:5px; font-weight:bold; color:{{ 'var(--nav)' if ex_cat_tab=='Spedycja' else '#999' }};">Spedycja</a>
            <a href="/admin?view={{ view }}&ex_cat=Material" style="flex:1; text-align:center; padding:5px; font-weight:bold; color:{{ 'var(--nav)' if ex_cat_tab=='Material' else '#999' }};">Materia≈Ç</a>
            <a href="/admin?view={{ view }}&ex_cat=Wycena" style="flex:1; text-align:center; padding:5px; font-weight:bold; color:{{ 'var(--nav)' if ex_cat_tab=='Wycena' else '#999' }};">Wycena</a>
        </div>

        <div class="list-group">
            {% set lista = open_ex if view == 'open' else (closed_ex if view == 'closed' else archive_folders.get(current_folder, [])) %}
            {% for ex in lista if ex[2] == ex_cat_tab %}
                <a href="/admin?view={{ view }}&ex_cat={{ ex_cat_tab }}&exchange_id={{ ex[0] }}{{ '&folder='+current_folder if view=='archive' else '' }}" class="{{ 'active' if sel_id == ex[0] }}">
                    {{ ex[1] }} <br><small>{{ ex[2] }}</small>
                </a>
            {% endfor %}
        </div>
    </div>

    <div>
    {% for item in ex_details %}
    {% set ex = item.info %}
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h2 style="margin:0; color:var(--nav);">{{ ex[1] }}</h2>
                <div style="display:flex; gap:5px;">
                    <a href="/send_invites/{{ ex[0] }}" class="btn" style="background:#f39c12;">‚úâÔ∏è Zapro≈õ</a>
                    
                    {% if view != 'archive' %}
                        <a href="/toggle_lock/{{ ex[0] }}" class="btn" style="background:#777;">{{ 'Otw√≥rz' if ex[4] else 'Zamknij' }}</a>
                    {% endif %}
                    {% if view == 'closed' %}
                        <form method="post" style="display:inline;"><input type="hidden" name="form_type" value="archive_exchange"><input type="hidden" name="eid" value="{{ ex[0] }}"><input type="text" name="folder_name" placeholder="Folder" style="width:80px; padding:6px;"><button class="btn">Archiwum</button></form>
                    {% endif %}
                    <form method="post" style="display:inline;"><input type="hidden" name="form_type" value="delete_exchange"><input type="hidden" name="eid" value="{{ ex[0] }}"><button class="btn btn-danger">X</button></form>
                </div>
            </div>

            {% if view != 'archive' %}
            <div style="background:#f1f8e9; padding:15px; margin-bottom:15px; border-radius:4px;">
                <form method="post">
                    <input type="hidden" name="form_type" value="edit_exchange_details">
                    <input type="hidden" name="eid" value="{{ ex[0] }}">
                    
                    {% if ex[2] == 'Spedycja' %}
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div class="form-group"><label class="form-label">Incoterms</label><select name="incoterms"><option value="{{ ex[14] }}">{{ ex[14] }}</option><option value="EXW">EXW</option><option value="FOB">FOB</option><option value="DAP">DAP</option></select></div>
                        <div class="form-group"><label class="form-label">Port</label><input type="text" name="port" value="{{ ex[15] }}"></div>
                        <div class="form-group"><label class="form-label">Data</label><input type="text" name="pickup" value="{{ ex[16] }}"></div>
                    </div>
                    {% endif %}
                    
                    <div class="form-group"><label class="form-label">Opis</label><textarea name="desc" rows="1">{{ ex[10] }}</textarea></div>
                    
                    <table>
                        <tr><th>Pozycja</th><th>Netto</th><th>Brutto</th><th>Vol</th><th>Kod Celny (18)</th><th>HS</th></tr>
                        {% for m in item.mats_offers %}
                        <tr>
                            <td>{{ m.data[2] }}<input type="hidden" name="m_id" value="{{ m.data[0] }}"></td>
                            <td><input type="text" name="net_{{ m.data[0] }}" value="{{ m.data[3] }}" style="width:60px;"></td>
                            <td><input type="text" name="gross_{{ m.data[0] }}" value="{{ m.data[4] }}" style="width:60px;"></td>
                            <td><input type="text" name="vol_{{ m.data[0] }}" value="{{ m.data[5] }}" style="width:60px;"></td>
                            <td><input type="text" name="code18_{{ m.data[0] }}" value="{{ m.data[11] if m.data[11] else '' }}"></td>
                            <td><input type="text" name="hs_{{ m.data[0] }}" value="{{ m.data[9] }}" style="width:60px;"></td>
                        </tr>
                        {% endfor %}
                    </table>
                    <button class="btn btn-sm" style="margin-top:5px;">Zapisz Zmiany</button>
                </form>
            </div>
            {% endif %}

            {% if view == 'open' %}
                <form method="post" enctype="multipart/form-data" style="margin-top:10px; background:#eee; padding:10px;">
                    <input type="hidden" name="form_type" value="add_item"><input type="hidden" name="exchange_id" value="{{ ex[0] }}">
                    <div style="display:flex; gap:5px; align-items:end;">
                        <div style="flex:1;"><label class="form-label">Nazwa</label><input type="text" name="name" required></div>
                        
                        {% if ex[2] == 'Spedycja' %}
                            <div style="width:70px;"><label class="form-label">Netto</label><input type="text" name="net"></div>
                            <div style="width:70px;"><label class="form-label">Brutto</label><input type="text" name="gross"></div>
                            <div style="width:70px;"><label class="form-label">Vol</label><input type="text" name="vol"></div>
                            <div style="width:70px;"><label class="form-label">HS</label><input type="text" name="hs"></div>
                        {% elif ex[2] == 'Material' %}
                            <div style="width:60px;"><label class="form-label">Sztuki</label><input type="text" name="qty"></div>
                            <div style="width:60px;"><label class="form-label">Laga (m)</label><input type="text" name="len"></div>
                            <div style="width:60px;"><label class="form-label">kg/m</label><input type="text" name="kg_m"></div>
                            <div style="width:60px;"><label class="form-label">HS</label><input type="text" name="hs"></div>
                        {% else %}
                            <div style="width:60px;"><label class="form-label">Ilo≈õƒá</label><input type="text" name="qty"></div>
                            <div><label class="form-label">PDF</label><input type="file" name="item_file"></div>
                        {% endif %}
                        
                        <button class="btn">+</button>
                    </div>
                </form>
            {% endif %}
            
            {% if ex[2] == 'Spedycja' %}
                <h4>Ranking (USD)</h4>
                <table><tr><th>Dostawca</th><th>Oferta</th><th>USD</th><th>Zej≈õcie</th></tr>
                {% for s in item.shipping_stats %}
                <tr style="{{ 'background:#d4edda; font-weight:bold;' if s.is_best else '' }}"><td>{{ s.user }}</td><td>{{ s.desc }}</td><td>{{ s.curr }} $</td><td style="color:red;">{{ s.drop }}%</td></tr>
                {% endfor %}
                </table>
            {% else %}
                <h4 style="margin-top:20px;">Pozycje</h4>
                {% for m in item.mats_offers %}
                    <div style="border-bottom:1px solid #eee; padding:5px;">
                        <strong>{{ m.data[2] }}</strong> 
                        {% if ex[2] == 'Material' %}({{ m.data[6] }} szt * {{ m.data[8] }} m * {{ m.data[7] }} kg/m = <strong>{{ m.data[3] }} kg</strong>){% endif %}
                        <table style="background:#fafafa;">{% for o in m.offers %}<tr style="{{ 'color:green;' if o.is_best else '' }}"><td>{{ o.user }}</td><td>{{ o.curr }} PLN</td><td>-{{ o.drop }}%</td></tr>{% endfor %}</table>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    {% endfor %}
    </div>
</div>
{% endif %}

</div>
</body>
</html>
