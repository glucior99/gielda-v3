<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>NECKS Portal Admin v5.1</title>
    <style>
        :root { --primary: #D32F2F; --nav: #1A237E; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; padding: 20px; color: #333; font-size: 13px; }
        .nav-bar { background: white; padding: 15px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; margin-bottom: 20px; }
        .logo { font-size: 24px; font-weight: 900; color: var(--primary); }
        .nav-links a { margin-left: 20px; text-decoration: none; color: #555; font-weight: 600; font-size: 12px; }
        .nav-links a.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        .main-tabs { display: flex; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
        .main-tab { padding: 10px 20px; text-decoration: none; color: #555; font-weight: bold; }
        .main-tab.active { color: var(--primary); border-bottom: 4px solid var(--primary); }
        .grid { display: grid; grid-template-columns: 250px 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-group { margin-bottom: 10px; }
        .form-label { display: block; font-weight: bold; font-size: 11px; color: #777; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .btn { padding: 8px 15px; background: var(--nav); color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-danger { background: var(--primary); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        th { text-align: left; padding: 10px; background: #eee; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .list-group a { display: block; padding: 10px; border-bottom: 1px solid #eee; text-decoration: none; color: #333; }
        .list-group a.active { background: #e8eaf6; border-left: 4px solid var(--nav); }
        .setting-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; }
        .set-tab { padding: 10px; cursor: pointer; font-weight: bold; color: #777; }
        .set-tab.active { color: var(--nav); border-bottom: 2px solid var(--nav); }
    </style>
    <script>
        function showSetting(id) {
            document.querySelectorAll('.set-content').forEach(d => d.style.display = 'none');
            document.querySelectorAll('.set-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).style.display = 'block';
            document.getElementById('tab-'+id).classList.add('active');
        }
    </script>
</head>
<body>

<div class="nav-bar">
    <div class="logo">NECKS <span>ADMIN</span></div>
    <div class="nav-links">
        <a href="/admin?view=dashboard" class="{{ 'active' if view == 'dashboard' }}">DASHBOARD</a>
        <a href="/admin?view=users" class="{{ 'active' if view == 'users' }}">U≈ªYTKOWNICY</a>
        <a href="/admin?view=open" class="{{ 'active' if view == 'open' }}">OTWARTE</a>
        <a href="/admin?view=closed" class="{{ 'active' if view == 'closed' }}">ZAMKNIƒòTE</a>
        <a href="/admin?view=archive" class="{{ 'active' if view == 'archive' }}">ARCHIWUM</a>
        <a href="/admin?view=settings" class="{{ 'active' if view == 'settings' }}">USTAWIENIA</a>
        <a href="/logout">WYLOGUJ</a>
    </div>
</div>

{% if view == 'settings' %}
<div class="card" style="max-width: 800px; margin: 0 auto;">
    <div class="setting-tabs">
        <div id="tab-mail" class="set-tab active" onclick="showSetting('mail')">Tre≈õƒá Maila</div>
        <div id="tab-cbam" class="set-tab" onclick="showSetting('cbam')">CBAM</div>
    </div>
    
    <div id="mail" class="set-content">
        <form action="/settings" method="post">
            <label class="form-label">Szablon Powiadomienia (zmienne: {GIE≈ÅDA}, {DATA})</label>
            <textarea name="mail_template" rows="8">{{ email_template }}</textarea>
            <button class="btn" style="margin-top:10px;">Zapisz Szablon</button>
        </form>
    </div>
    
    <div id="cbam" class="set-content" style="display:none; text-align:center; padding:50px; color:#999;">
        <h2>CBAM - Konfiguracja</h2>
        <p>Modu≈Ç w przygotowaniu...</p>
    </div>
</div>
{% endif %}

{% if view == 'dashboard' %}
<div class="card" style="max-width: 800px; margin: 0 auto;">
    <h3>Utw√≥rz NowƒÖ Aukcjƒô</h3>
    <form method="post" enctype="multipart/form-data">
        <input type="hidden" name="form_type" value="create_exchange">
        
        <div class="form-group"><label class="form-label">Nazwa</label><input type="text" name="exchange_name" required></div>
        
        <div style="display:flex; gap:15px;">
            <div class="form-group" style="flex:1"><label class="form-label">Kategoria</label>
                <select name="category" id="catSelect" onchange="toggleFiles()">
                    <option value="Spedycja">Spedycja</option>
                    <option value="Material">Materia≈Ç</option>
                    <option value="Wycena">Wycena</option>
                </select>
            </div>
            <div class="form-group" style="flex:1"><label class="form-label">Deadline</label><input type="datetime-local" name="deadline" required></div>
        </div>

        <div style="display:flex; gap:15px; background:#f9f9f9; padding:10px; margin-bottom:10px;">
            <div class="form-group" style="flex:1">
                <label class="form-label">Incoterms</label>
                <select name="incoterms">
                    <option value="EXW">EXW</option>
                    <option value="FOB">FOB</option>
                    <option value="FCA">FCA</option>
                    <option value="DAP">DAP</option>
                    <option value="DDP">DDP</option>
                </select>
            </div>
            <div class="form-group" style="flex:1"><label class="form-label">Port Za≈Çadunku</label><input type="text" name="port_loading"></div>
            <div class="form-group" style="flex:1"><label class="form-label">Termin Odbioru</label><input type="text" name="pickup_date"></div>
        </div>

        <div class="form-group"><label class="form-label">Opis</label><textarea name="desc" rows="3"></textarea></div>

        <div id="spedycjaFiles" style="background:#e3f2fd; padding:10px; margin-bottom:10px;">
            <div class="form-group"><label class="form-label">Packing List (PDF)</label><input type="file" name="af1"></div>
            <div class="form-group"><label class="form-label">Inne (PDF)</label><input type="file" name="af2"></div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <div class="form-group"><label class="form-label">EUR</label><input type="text" name="eur_rate" value="{{ live_eur }}"></div>
            <div class="form-group"><label class="form-label">USD</label><input type="text" name="usd_rate" value="{{ live_usd }}"></div>
        </div>

        <div class="form-group"><label><input type="checkbox" name="notify_enabled"> Auto-Alert o przebiciu</label></div>
        
        <button class="btn">Utw√≥rz</button>
    </form>
    <script>
        function toggleFiles() { 
            document.getElementById('spedycjaFiles').style.display = 
                (document.getElementById('catSelect').value === 'Spedycja') ? 'block' : 'none'; 
        }
        toggleFiles();
    </script>
</div>
{% endif %}

{% if view == 'users' %}
<div class="card">
    <div style="margin-bottom:15px;">
        <a href="/admin?view=users&user_cat=Spedycja" class="btn" style="background:{{ 'var(--nav)' if user_cat_tab=='Spedycja' else '#ccc' }}">Spedycja</a>
        <a href="/admin?view=users&user_cat=Material" class="btn" style="background:{{ 'var(--nav)' if user_cat_tab=='Material' else '#ccc' }}">Materia≈Ç</a>
        <a href="/admin?view=users&user_cat=Wycena" class="btn" style="background:{{ 'var(--nav)' if user_cat_tab=='Wycena' else '#ccc' }}">Wycena</a>
    </div>
    
    <form action="/manage_user" method="post" style="background:#eee; padding:10px; margin-bottom:15px;">
        <input type="hidden" name="action" value="add">
        <input type="hidden" name="category" value="{{ user_cat_tab }}">
        <input type="text" name="username" placeholder="Email/Login" required style="width:200px;">
        <input type="text" name="password" placeholder="Has≈Ço" required style="width:200px;">
        <button class="btn">Dodaj</button>
    </form>

    <table>
        <tr><th>User</th><th>Has≈Ço</th><th>Akcja</th></tr>
        {% for u in all_users_list if u[3] == user_cat_tab %}
        <tr>
            <form action="/manage_user" method="post">
                <input type="hidden" name="uid" value="{{ u[0] }}">
                <td><input type="text" name="username" value="{{ u[1] }}"></td>
                <td><input type="text" name="password" placeholder="Zmie≈Ñ has≈Ço"></td>
                <td>
                    <button name="action" value="edit" class="btn" style="padding:5px;">Zapisz</button>
                    <button name="action" value="toggle" class="btn" style="background:{{ '#2e7d32' if u[2] else '#c62828' }}; padding:5px;">{{ 'Aktywny' if u[2] else 'Nieakt.' }}</button>
                    <button name="action" value="delete" class="btn btn-danger" style="padding:5px;">X</button>
                </td>
            </form>
        </tr>
        {% endfor %}
    </table>
</div>
{% endif %}

{% if view in ['open', 'closed', 'archive'] %}
<div class="grid">
    <div class="card" style="padding:0;">
        {% if view == 'archive' %}
            {% for f in archive_folders.keys() %}
                <a href="/admin?view=archive&folder={{ f }}" style="display:block; padding:10px; border-bottom:1px solid #eee;">üìÇ {{ f }}</a>
            {% endfor %}
        {% endif %}
        
        <div class="list-group">
            {% set lista = open_ex if view == 'open' else (closed_ex if view == 'closed' else archive_folders.get(current_folder, [])) %}
            {% for ex in lista %}
                <a href="/admin?view={{ view }}&exchange_id={{ ex[0] }}{{ '&folder='+current_folder if view=='archive' else '' }}" class="{{ 'active' if sel_id == ex[0] }}">
                    {{ ex[1] }} <br><small>{{ ex[2] }}</small>
                </a>
            {% endfor %}
        </div>
    </div>

    <div>
    {% for item in ex_details %}
    {% set ex = item.info %}
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h2 style="margin:0; color:var(--nav);">{{ ex[1] }}</h2>
                <div style="display:flex; gap:5px;">
                    <a href="/send_invites/{{ ex[0] }}" class="btn" style="background:#f39c12;" title="Wy≈õlij Zaproszenia Email">‚úâÔ∏è Zapro≈õ</a>
                    
                    {% if view != 'archive' %}
                        <a href="/toggle_lock/{{ ex[0] }}" class="btn" style="background:#777;">{{ 'Otw√≥rz' if ex[4] else 'Zamknij' }}</a>
                    {% endif %}
                    {% if view == 'closed' %}
                        <form method="post" style="display:inline;"><input type="hidden" name="form_type" value="archive_exchange"><input type="hidden" name="eid" value="{{ ex[0] }}"><input type="text" name="folder_name" placeholder="Folder" style="width:80px; padding:6px;"><button class="btn">Archiwum</button></form>
                    {% endif %}
                    <form method="post" style="display:inline;"><input type="hidden" name="form_type" value="delete_exchange"><input type="hidden" name="eid" value="{{ ex[0] }}"><button class="btn btn-danger">X</button></form>
                </div>
            </div>

            {% if view != 'archive' %}
            <div style="background:#f1f8e9; padding:15px; margin-bottom:15px; border-radius:4px;">
                <form method="post">
                    <input type="hidden" name="form_type" value="edit_exchange_details">
                    <input type="hidden" name="eid" value="{{ ex[0] }}">
                    
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div class="form-group"><label class="form-label">Incoterms</label>
                            <select name="incoterms">
                                <option value="{{ ex[14] }}">{{ ex[14] if ex[14] else 'Wybierz' }}</option>
                                <option value="EXW">EXW</option><option value="FOB">FOB</option><option value="DAP">DAP</option>
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label">Port</label><input type="text" name="port" value="{{ ex[15] }}"></div>
                        <div class="form-group"><label class="form-label">Data Odbioru</label><input type="text" name="pickup" value="{{ ex[16] }}"></div>
                    </div>
                    <div class="form-group"><label class="form-label">Opis</label><textarea name="desc" rows="1">{{ ex[10] }}</textarea></div>
                    
                    <table>
                        <tr><th>Pozycja</th><th>Netto</th><th>Brutto</th><th>Vol</th><th>Kod Celny</th></tr>
                        {% for m in item.mats_offers %}
                        <tr>
                            <td>{{ m.data[2] }}<input type="hidden" name="m_id" value="{{ m.data[0] }}"></td>
                            <td><input type="text" name="net_{{ m.data[0] }}" value="{{ m.data[3] }}" style="width:60px;"></td>
                            <td><input type="text" name="gross_{{ m.data[0] }}" value="{{ m.data[4] }}" style="width:60px;"></td>
                            <td><input type="text" name="vol_{{ m.data[0] }}" value="{{ m.data[5] }}" style="width:60px;"></td>
                            <td><input type="text" name="code18_{{ m.data[0] }}" value="{{ m.data[11] if m.data[11] else '' }}"></td>
                        </tr>
                        {% endfor %}
                    </table>
                    <button class="btn" style="margin-top:5px;">Zapisz Zmiany</button>
                </form>
            </div>
            {% endif %}

            {% if ex[2] == 'Spedycja' %}
                <h4>Ranking (USD)</h4>
                <table>
                    <tr><th>Dostawca</th><th>Oferta</th><th>USD</th><th>Zej≈õcie</th></tr>
                    {% for s in item.shipping_stats %}
                    <tr style="{{ 'background:#d4edda; font-weight:bold;' if s.is_best else '' }}">
                        <td>{{ s.user }}</td><td>{{ s.desc }}</td><td>{{ s.curr }} $</td>
                        <td style="color:red;">{{ s.drop }}%</td>
                    </tr>
                    {% endfor %}
                </table>
            {% endif %}

            <h4 style="margin-top:20px;">Pozycje</h4>
            {% for m in item.mats_offers %}
                <div style="border-bottom:1px solid #eee; padding:5px;">
                    <strong>{{ m.data[2] }}</strong> (HS: {{ m.data[9] }})
                    {% if ex[2] != 'Spedycja' %}
                        <table style="background:#fafafa;">
                            {% for o in m.offers %}
                            <tr style="{{ 'color:green; font-weight:bold;' if o.is_best else '' }}">
                                <td>{{ o.user }}</td><td>{{ o.curr }} PLN</td>
                                <td>-{{ o.drop }}%</td><td>{{ o.sub }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                    {% endif %}
                    <a href="/delete_material/{{ m.data[0] }}" style="color:red; font-size:10px;">Usu≈Ñ pozycjƒô</a>
                </div>
            {% endfor %}

            {% if view == 'open' %}
                <form method="post" enctype="multipart/form-data" style="margin-top:10px; background:#eee; padding:10px;">
                    <input type="hidden" name="form_type" value="add_item"><input type="hidden" name="exchange_id" value="{{ ex[0] }}">
                    <div style="display:flex; gap:5px;">
                        <input type="text" name="name" placeholder="Nazwa" required>
                        <input type="text" name="qty" placeholder="Ilo≈õƒá" style="width:60px;">
                        <input type="text" name="hs" placeholder="Kod HS">
                        <button class="btn">+</button>
                    </div>
                </form>
            {% endif %}
        </div>
    {% endfor %}
    </div>
</div>
{% endif %}

</div>
</body>
</html>
