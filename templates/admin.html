<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel v4.0</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; color: #333; font-size: 13px; }
        
        .nav-bar { background: var(--primary); color: white; padding: 15px; border-radius: 5px; display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .nav-bar a { color: white; text-decoration: none; border: 1px solid white; padding: 5px 15px; border-radius: 3px; font-weight: bold; }
        
        .main-tabs { display: flex; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
        .main-tab { padding: 10px 20px; text-decoration: none; color: #555; font-weight: bold; border-bottom: 4px solid transparent; }
        .main-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .sub-tabs { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; }
        .tab { padding: 6px 12px; background: #ddd; text-decoration: none; color: #555; border-radius: 3px; font-weight: bold; font-size: 12px; }
        .tab.active { background: var(--accent); color: white; }
        
        .grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Input Styles */
        .form-group { margin-bottom: 10px; }
        .form-label { display: block; font-weight: bold; margin-bottom: 3px; font-size: 11px; color: #555; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 10px; border: none; background: var(--success); color: white; cursor: pointer; font-weight: bold; border-radius: 4px; }
        .btn-danger { background: var(--danger); }
        .btn-blue { background: var(--accent); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        th, td { padding: 8px; border: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; }
        
        .best-row { background: #d4edda; font-weight: bold; }
        .folder-list { display: flex; gap: 10px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .folder-tab { color: #555; text-decoration: none; font-weight: bold; font-size: 14px; }
        .folder-tab.active { color: var(--accent); text-decoration: underline; }
    </style>
</head>
<body>

<div class="nav-bar">
    <div style="font-size: 18px; font-weight: bold;">ADMINISTRATOR SYSTEMU</div>
    <a href="/logout">Wyloguj</a>
</div>

<div class="main-tabs">
    <a href="/admin?view=dashboard" class="main-tab {% if view == 'dashboard' %}active{% endif %}">DASHBOARD (OTWARTE)</a>
    <a href="/admin?view=closed" class="main-tab {% if view == 'closed' %}active{% endif %}">ZAMKNIƒòTE / EDYCJA</a>
    <a href="/admin?view=archive" class="main-tab {% if view == 'archive' %}active{% endif %}">ARCHIWUM</a>
    <a href="/admin?view=settings" class="main-tab {% if view == 'settings' %}active{% endif %}">USTAWIENIA ‚öôÔ∏è</a>
</div>

{% if view == 'settings' %}
<div class="card">
    <h3>Ustawienia E-mail</h3>
    <form action="/settings" method="post">
        <div class="form-group">
            <label class="form-label">Szablon wiadomo≈õci e-mail (U≈ºyj {GIE≈ÅDA} i {DATA} jako zmiennych)</label>
            <textarea name="mail_template" rows="5">{{ email_template }}</textarea>
        </div>
        <button class="btn btn-blue" style="width: auto;">Zapisz Szablon</button>
    </form>
</div>
{% endif %}

{% if view == 'dashboard' and not sel_id %}
<div class="grid">
    <div class="card">
        <h3>Nowa Gie≈Çda</h3>
        <div style="background:#fff3cd; padding:5px; text-align:center; margin-bottom:10px; font-size:11px;">
            Kurs NBP: 1 EUR = {{ live_eur }} PLN | 1 USD = {{ live_usd }} PLN
        </div>
        <form method="post" enctype="multipart/form-data">
            <input type="hidden" name="form_type" value="create_exchange">
            
            <div class="form-group">
                <label class="form-label">Nazwa Gie≈Çdy</label>
                <input type="text" name="exchange_name" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Kategoria</label>
                <select name="category">
                    <option value="Spedycja">Spedycja</option>
                    <option value="Material">Materia≈Ç</option>
                    <option value="Wycena">Wycena</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Termin Zako≈Ñczenia</label>
                <input type="datetime-local" name="deadline" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Opis (Dla dostawc√≥w)</label>
                <textarea name="desc" rows="2"></textarea>
            </div>
            
            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label class="form-label">Kurs EUR (Manual)</label>
                    <input type="text" name="eur_rate" value="{{ live_eur }}">
                </div>
                <div style="flex:1">
                    <label class="form-label">Kurs USD (Manual)</label>
                    <input type="text" name="usd_rate" value="{{ live_usd }}">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Za≈ÇƒÖczniki (PDF)</label>
                <input type="file" name="af1" accept=".pdf">
                <input type="file" name="af2" accept=".pdf">
            </div>

            <div class="form-group">
                <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                    <input type="checkbox" name="notify_enabled" style="width:auto;"> 
                    <span style="font-weight:bold; color:#2980b9;">W≈ÇƒÖcz Auto-Mailing przy przebiciu</span>
                </label>
            </div>
            
            <button type="submit" class="btn">Utw√≥rz Gie≈Çdƒô</button>
        </form>
    </div>

    <div class="card">
        <h3>ZarzƒÖdzanie U≈ºytkownikami</h3>
        <form action="/manage_user" method="post" style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
            <input type="hidden" name="action" value="add">
            <div style="display:flex; gap:5px;">
                <input type="text" name="username" placeholder="Login/Email" required>
                <input type="text" name="password" placeholder="Has≈Ço" required>
                <select name="category" style="width:120px;">
                    <option value="Spedycja">Spedycja</option>
                    <option value="Material">Materia≈Ç</option>
                    <option value="Wycena">Wycena</option>
                </select>
            </div>
            <button type="submit" class="btn" style="margin-top:5px;">Dodaj U≈ºytkownika</button>
        </form>

        <div style="max-height:300px; overflow-y:auto;">
            <table style="margin-top:0;">
                <tr><th>User</th><th>Kat</th><th>Edycja</th></tr>
                {% for u in all_users_list %}
                <tr style="background: {{ '#fff' if u[2] else '#f0f0f0' }}; color: {{ 'black' if u[2] else '#999' }};">
                    <td>{{ u[1] }}</td>
                    <td>{{ u[3] }}</td>
                    <td>
                        <form action="/manage_user" method="post" style="display:flex; gap:2px;">
                            <input type="hidden" name="uid" value="{{ u[0] }}">
                            <input type="text" name="password" placeholder="Nowe has≈Ço" style="width:80px; padding:2px; height:20px; font-size:10px;">
                            <button name="action" value="edit" class="btn-blue" style="width:auto; padding:2px 5px; font-size:10px;">Zmie≈Ñ</button>
                            <button name="action" value="toggle" style="width:auto; padding:2px 5px; font-size:10px; background:#7f8c8d;">I/O</button>
                            <button name="action" value="delete" class="btn-danger" style="width:auto; padding:2px 5px; font-size:10px;" onclick="return confirm('UsunƒÖƒá?')">X</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
</div>
{% endif %}

{% if view == 'archive' %}
    <div class="folder-list">
        {% for folder in archive_folders.keys() %}
            <a href="/admin?view=archive&folder={{ folder }}" class="folder-tab {% if current_folder == folder %}active{% endif %}">üìÇ {{ folder }}</a>
        {% endfor %}
    </div>
{% endif %}

<div class="sub-tabs">
    {% set gieldy_lista = open_ex if view == 'dashboard' else (closed_ex if view == 'closed' else archive_folders.get(current_folder, [])) %}
    {% for ex in gieldy_lista %}
        <a href="/admin?view={{ view }}&exchange_id={{ ex[0] }}{{ '&folder=' + current_folder if view=='archive' else '' }}" 
           class="tab {% if sel_id == ex[0] %}active{% endif %}">{{ ex[1] }}</a>
    {% endfor %}
</div>

{% for item in ex_details %}
{% set ex = item.info %}
<div class="card">
    <div style="display:flex; justify-content:space-between;">
        <div>
            <h2>{{ ex[1] }} <span style="font-size:14px; color:#777;">({{ ex[2] }})</span></h2>
            <div style="color:#555; font-style:italic;">{{ ex[10] }}</div>
        </div>
        
        <div style="text-align:right;">
            {% if view == 'closed' %}
                <form method="post" style="display:inline-block;">
                    <input type="hidden" name="form_type" value="archive_exchange">
                    <input type="hidden" name="eid" value="{{ ex[0] }}">
                    <input type="text" name="folder_name" placeholder="Nazwa folderu (np. Stycze≈Ñ)" required style="width:150px;">
                    <button class="btn" style="width:auto; background:#f39c12;">Archiwizuj</button>
                </form>
            {% endif %}
            
            {% if view != 'archive' %}
                <a href="/toggle_lock/{{ ex[0] }}" class="btn" style="display:inline-block; width:auto; background:#3498db; text-decoration:none; padding:8px;">
                    {{ 'Odblokuj' if ex[4] else 'Zablokuj' }}
                </a>
            {% endif %}
            
            <form method="post" style="display:inline-block;" onsubmit="return confirm('Czy na pewno chcesz CA≈ÅKOWICIE usunƒÖƒá tƒô gie≈Çdƒô?');">
                <input type="hidden" name="form_type" value="delete_exchange">
                <input type="hidden" name="eid" value="{{ ex[0] }}">
                <button class="btn btn-danger" style="width:auto; padding:8px;">Usu≈Ñ</button>
            </form>
        </div>
    </div>

    {% if view == 'closed' %}
    <div style="background:#ecf0f1; padding:10px; margin-top:10px; border-radius:5px;">
        <h4>Edycja Zamkniƒôtej Gie≈Çdy (Wagi / Kody Celne)</h4>
        <form method="post">
            <input type="hidden" name="form_type" value="edit_exchange_details">
            <input type="hidden" name="eid" value="{{ ex[0] }}">
            
            <div class="form-group">
                <label class="form-label">Edytuj Opis Gie≈Çdy:</label>
                <textarea name="desc" rows="1">{{ ex[10] }}</textarea>
            </div>
            
            <table>
                <tr><th>Pozycja</th><th>Waga Netto</th><th>Waga Brutto</th><th>Objƒôto≈õƒá</th><th>Kod Celny (18 znak√≥w)</th></tr>
                {% for m in item.mats_offers %}
                <tr>
                    <td>{{ m.data[2] }} <input type="hidden" name="m_id" value="{{ m.data[0] }}"></td>
                    <td><input type="text" name="net_{{ m.data[0] }}" value="{{ m.data[3] }}"></td>
                    <td><input type="text" name="gross_{{ m.data[0] }}" value="{{ m.data[4] }}"></td>
                    <td><input type="text" name="vol_{{ m.data[0] }}" value="{{ m.data[5] }}"></td>
                    <td><input type="text" name="code18_{{ m.data[0] }}" value="{{ m.data[11] if m.data[11] else '' }}" maxlength="18"></td>
                </tr>
                {% endfor %}
            </table>
            <button class="btn" style="margin-top:5px; width:auto;">Zapisz Zmiany W/B/V/Code</button>
        </form>
    </div>
    {% endif %}

    {% if ex[2] == 'Spedycja' %}
        <h4>Ranking Ofert (USD)</h4>
        <table>
            <tr><th>Dostawca</th><th>Oferta</th><th>USD Total</th><th>Zej≈õcie</th><th>Status</th></tr>
            {% for s in item.shipping_stats %}
            <tr class="{{ 'best-row' if s.is_best else '' }}">
                <td>{{ s.user }}</td>
                <td>{{ s.desc }}</td>
                <td><strong>{{ s.curr_total }} $</strong></td>
                <td style="color:red;">-{{ s.drop_pct }}%</td>
                <td>{{ s.label }}</td>
            </tr>
            {% endfor %}
        </table>
    {% else %}
        <h4>Oferty Materia≈Çowe</h4>
        {% for m in item.mats_offers %}
            <div style="border:1px solid #ddd; padding:5px; margin-bottom:5px;">
                <strong>{{ m.data[2] }}</strong> 
                (Kod celny: {{ m.data[11] if m.data[11] else '-' }})
                
                <table style="width:100%; margin-top:5px;">
                    <tr><th>Dostawca</th><th>Cena (PLN)</th><th>Zej≈õcie</th><th>Info</th><th>Ranking</th></tr>
                    {% for o in m.offers %}
                    <tr class="{{ 'best-row' if o.is_best else '' }}">
                        <td>{{ o.user }}</td>
                        <td>{{ o.curr }} PLN</td>
                        <td style="color:red;">-{{ o.drop }}%</td>
                        <td>{{ o.sub }}</td>
                        <td>{{ o.label }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        {% endfor %}
    {% endif %}
    
    {% if view == 'dashboard' %}
    <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
        <strong>Dodaj pozycjƒô:</strong>
        <form method="post" enctype="multipart/form-data" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap:5px; align-items:end;">
            <input type="hidden" name="form_type" value="add_item">
            <input type="hidden" name="exchange_id" value="{{ ex[0] }}">
            
            <div><label class="form-label">Nazwa</label><input type="text" name="name" required></div>
            {% if ex[2] == 'Material' %}
                <div><label class="form-label">Ilo≈õƒá</label><input type="text" name="qty"></div>
                <div><label class="form-label">D≈Ç (m)</label><input type="text" name="len"></div>
                <div><label class="form-label">kg/m</label><input type="text" name="kg_m"></div>
            {% elif ex[2] == 'Spedycja' %}
                <div><label class="form-label">Waga Net</label><input type="text" name="net"></div>
                <div><label class="form-label">Waga Brut</label><input type="text" name="gross"></div>
                <div><label class="form-label">Objƒôto≈õƒá</label><input type="text" name="vol"></div>
                <div><label class="form-label">PDF</label><input type="file" name="item_file"></div>
            {% else %}
                <div><label class="form-label">Sztuki</label><input type="text" name="qty"></div>
            {% endif %}
            
            <button class="btn" style="padding:8px;">+</button>
        </form>
    </div>
    {% endif %}
</div>
{% endfor %}

</body>
</html>
