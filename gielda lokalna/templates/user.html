<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Dostawca</title>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px 20px 80px 20px; color: #333; font-size: 13px; }
        .nav-bar { background: #2c3e50; color: white; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; margin-bottom: 20px; }
        .nav-bar a { color: white; text-decoration: none; border: 1px solid white; padding: 3px 10px; border-radius: 3px; }
        .card { background: white; padding: 15px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; border-left: 5px solid #3498db; }
        .spedycja-card { border-left-color: #f39c12; }
        .desc-box { background: #e8f6f3; padding: 10px; border-radius: 4px; margin: 10px 0; font-style: italic; color: #16a085; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: left; vertical-align: top; }
        th { background: #f8f9fa; }
        input { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box; }
        .calc-box { background: #fff3cd; padding: 10px; margin-top: 10px; border-radius: 5px; font-weight: bold; }
        .btn { width:100%; background:#27ae60; color:white; border:none; padding:10px; font-weight:bold; cursor:pointer; margin-top:10px; }
        .rank-badge { color: blue; font-weight: bold; font-size: 11px; display: block; margin-top: 2px; }
    </style>
    <script>
        function calcSpedycja(id, rateE, rateU) {
            let p = parseFloat(document.getElementById('pln_'+id).value.replace(',', '.') || 0);
            let e = parseFloat(document.getElementById('eur_'+id).value.replace(',', '.') || 0);
            let u = parseFloat(document.getElementById('usd_'+id).value.replace(',', '.') || 0);
            let total = p + (e / rateE) + (u / rateU);
            document.getElementById('total_'+id).innerText = total.toFixed(2) + " PLN";
        }
        function toggleSub(id) {
            var chk = document.getElementById('chk_'+id);
            var inp = document.getElementById('sub_'+id);
            inp.style.display = chk.checked ? 'block' : 'none';
        }
    </script>
</head>
<body>

<div class="nav-bar">
    <div>Dostawca: {{ session['user'] }} ({{ session['category'] }})</div>
    <a href="/logout">Wyloguj</a>
</div>

{% for ex in exchange_data %}
<form action="/save_offer/{{ ex.id }}" method="post" enctype="multipart/form-data">
    <div class="card {% if ex.cat == 'Spedycja' %}spedycja-card{% endif %}">
        <div style="display:flex; justify-content:space-between;">
            <h2>{{ ex.name }} <small>({{ ex.cat }})</small></h2>
            <div>{% if ex.cat == 'Spedycja' %}1 EUR={{ ex.eur }} | 1 USD={{ ex.usd }}{% endif %}</div>
        </div>
        
        {% if ex.desc %}
            <div class="desc-box">INFO: {{ ex.desc }}</div>
        {% endif %}

        {% if ex.f1 or ex.f2 %}
        <div style="margin-bottom:10px;">
            Pliki: {% if ex.f1 %}<a href="/static/uploads/{{ ex.f1 }}" target="_blank">PDF 1</a>{% endif %}
            {% if ex.f2 %} | <a href="/static/uploads/{{ ex.f2 }}" target="_blank">PDF 2</a>{% endif %}
        </div>
        {% endif %}

        {% if ex.cat == 'Spedycja' %}
            <table>
                <tr><th>Nazwa</th><th>Dane</th><th>HS</th><th>Plik</th></tr>
                {% for m in ex.mats %}
                <tr>
                    <td>{{ m.name }}</td>
                    <td>Net:{{ m.net }} / Brut:{{ m.gross }} / Vol:{{ m.vol }}</td>
                    <td>{{ m.hs }}</td>
                    <td>{% if m.admin_file %}<a href="/static/uploads/{{ m.admin_file }}" target="_blank">PDF</a>{% endif %}</td>
                </tr>
                {% endfor %}
            </table>
            
            <div class="calc-box">
                Oferta łączna:
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:5px;">
                    <div><input type="text" name="sp_pln" id="pln_{{ ex.id }}" placeholder="PLN" value="{{ ex.shipping_bid[0] if ex.shipping_bid else '' }}" oninput="calcSpedycja({{ ex.id }}, {{ ex.eur }}, {{ ex.usd }})"></div>
                    <div><input type="text" name="sp_eur" id="eur_{{ ex.id }}" placeholder="EUR" value="{{ ex.shipping_bid[1] if ex.shipping_bid else '' }}" oninput="calcSpedycja({{ ex.id }}, {{ ex.eur }}, {{ ex.usd }})"></div>
                    <div><input type="text" name="sp_usd" id="usd_{{ ex.id }}" placeholder="USD" value="{{ ex.shipping_bid[2] if ex.shipping_bid else '' }}" oninput="calcSpedycja({{ ex.id }}, {{ ex.eur }}, {{ ex.usd }})"></div>
                </div>
                <div style="margin-top:5px; text-align:right;">
                    Twój Ranking: <strong style="color:blue;">
                        {% if ex.shipping_rank == 'REMIS' %}REMIS (1){% else %}{{ ex.shipping_rank }}{% endif %}
                    </strong>
                    <br>Razem: <span id="total_{{ ex.id }}">{{ ex.shipping_bid[3] if ex.shipping_bid else '0.00' }} PLN</span>
                </div>
            </div>

        {% else %}
            <table>
                <tr>
                    <th>Nazwa</th>
                    {% if ex.cat == 'Material' %}
                        <th>Szt.</th>
                        <th>Długość</th>
                        <th>kg/m</th>
                        <th>Waga</th>
                    {% else %}
                        <th>Sztuki</th>
                    {% endif %}
                    <th>{{ "Cena za kg (PLN)" if ex.cat == 'Material' else "Cena (PLN)" }}</th>
                    <th>Inne</th>
                </tr>
                {% for m in ex.mats %}
                <tr>
                    <td>
                        {{ m.name }}
                        {% if m.rank != "-" %}
                            <span class="rank-badge">
                                {% if m.rank == 'REMIS' %}REMIS (1){% else %}Miejsce: {{ m.rank }}{% endif %}
                            </span>
                        {% endif %}
                    </td>
                    
                    {% if ex.cat == 'Material' %}
                        <td>{{ m.qty }}</td>
                        <td><b>{{ m.len }} m</b></td>
                        <td>{{ m.kg_m }}</td>
                        <td>{{ m.net }}</td>
                    {% else %}
                        <td>{{ m.qty }}</td>
                    {% endif %}
                    
                    <td>
                        <input type="text" name="price_{{ m.id }}" value="{{ m.saved[0] if m.saved else '' }}" placeholder="Cena">
                    </td>

                    <td>
                        {% if ex.cat == 'Wycena' %}
                            <label style="font-size:11px;">
                                <input type="checkbox" id="chk_{{ m.id }}" name="sub_check_{{ m.id }}" onchange="toggleSub({{ m.id }})" {% if m.saved and m.saved[5] %}checked{% endif %}> Zamiennik?
                            </label>
                            <input type="text" id="sub_{{ m.id }}" name="sub_note_{{ m.id }}" placeholder="Opisz zamiennik..." style="display:{{ 'block' if m.saved and m.saved[5] else 'none' }}; margin-top:5px; font-size:11px;" value="{{ m.saved[5] if m.saved else '' }}">
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </table>
        {% endif %}
        
        <button type="submit" class="btn">ZAPISZ OFERTĘ</button>
    </div>
</form>
{% endfor %}

</body>
</html>